<!DOCTYPE html>
<html lang="fi">
<head>
  <meta name="google-site-verification" content="sXMN4dnMScUNOE96_sUV1Bq6OWb-BSMqJXub_Y2BCGU" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shakki</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom, #fef3c7, #fde68a);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    /* KirjautumisnÃ¤kymÃ¤n tyylit */
    #auth-screen {
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      padding: 3rem;
      text-align: center;
      max-width: 500px;
      width: 100%;
    }

    .btn-login-big {
      background: #2563eb;
      color: white;
      font-size: 1.5rem;
      padding: 1.2rem 2.5rem;
      border-radius: 1rem;
      width: 100%;
      border: none;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      transition: transform 0.2s, background 0.2s;
      margin-bottom: 1rem;
    }

    .btn-login-big:hover {
      background: #1d4ed8;
      transform: scale(1.02);
    }

    .btn-skip {
      background: #f3f4f6;
      color: #4b5563;
      font-size: 1rem;
      padding: 0.8rem 1.5rem;
      border-radius: 0.75rem;
      width: 100%;
      border: 1px solid #d1d5db;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    .btn-skip:hover {
      background: #e5e7eb;
    }

    #menu, #difficulty-menu, #game-container {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      position: relative;
    }

    .coin-display {
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      background: #facc15;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-weight: bold;
      color: #78350f;
      border: 2px solid #d97706;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #78350f;
      font-size: 2.5rem;
      margin-bottom: 2rem;
    }

    h2 {
      text-align: center;
      color: #78350f;
      font-size: 2rem;
      margin-bottom: 1.5rem;
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    button {
      padding: 1rem 1.5rem;
      font-size: 1.25rem;
      font-weight: bold;
      border: none;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }

    .btn-2player { background: #16a34a; }
    .btn-2player:hover { background: #15803d; }

    .btn-ai { background: #2563eb; }
    .btn-ai:hover { background: #1d4ed8; }

    .btn-easy { background: #22c55e; }
    .btn-easy:hover { background: #16a34a; }

    .btn-medium { background: #eab308; }
    .btn-medium:hover { background: #ca8a04; }

    .btn-hard { background: #dc2626; }
    .btn-hard:hover { background: #b91c1c; }

    .btn-expert { background: #7c2d12; }
    .btn-expert:hover { background: #431407; }

    .btn-back, .btn-menu { background: #6b7280; }
    .btn-back:hover, .btn-menu:hover { background: #4b5563; }

    .btn-fullscreen { background: #9333ea; }
    .btn-fullscreen:hover { background: #7e22ce; }

    .btn-undo { background: #eab308; }
    .btn-undo:hover { background: #ca8a04; }
    .btn-undo:disabled { background: #d1d5db; cursor: not-allowed; }

    .btn-reset { background: #dc2626; }
    .btn-reset:hover { background: #b91c1c; }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .game-status {
      color: #78350f;
      font-size: 1.5rem;
      font-weight: bold;
    }

    .game-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .game-buttons button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }

    #board {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      border: 4px solid #78350f;
      border-radius: 0.5rem;
      overflow: hidden;
      margin: 0 auto;
      max-width: 600px;
      aspect-ratio: 1/1;
    }

    .square {
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      font-size: 4rem;
      user-select: none;
      transition: opacity 0.2s;
    }

    .light { background: #fffbeb; }
    .dark { background: #16a34a; }

    .selected { box-shadow: inset 0 0 0 4px #facc15; }

    .white-piece {
      color: #f3f4f6;
      -webkit-text-stroke: 2px black;
      text-shadow: 0 0 2px #000;
    }

    .black-piece { color: #111827; }

    .legal-move {
      position: absolute;
      width: 1.5rem;
      height: 1.5rem;
      background: #4ade80;
      border-radius: 50%;
      opacity: 0.7;
      pointer-events: none;
    }

    .hidden { display: none; }

    .footer-link {
      margin-top: 2rem;
      color: #6b7280;
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }

    .footer-link:hover {
      color: #374151;
      text-decoration: underline;
    }

    #fullscreen-overlay {
      position: fixed;
      inset: 0;
      background: black;
      z-index: 999999;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #fullscreen-overlay.active { display: flex; }

    #fullscreen-board {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      width: 100vmin;
      height: 100vmin;
    }

    #fullscreen-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: white;
      font-size: 3rem;
      cursor: pointer;
      z-index: 1000000;
    }

    .fullscreen-square {
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
    }

    .fullscreen-piece { font-size: clamp(2rem, 8vmin, 6rem); }
  </style>
</head>
<body>

  <!-- KIRJAUTUMISRUUTU -->
  <div id="auth-screen">
    <h1 style="margin-bottom: 1rem;">â™” Shakki â™š</h1>
    <p style="color: #6b7280; margin-bottom: 2rem;">Pelaaminen vaatii sisÃ¤Ã¤nkirjautumisen.</p>
    <button class="btn-login-big" onclick="redirectToLogin()">KIRJAUDU SISÃ„Ã„N</button>
    <button class="btn-skip" onclick="skipLogin()">Ei nyt</button>
  </div>

  <div id="menu" class="hidden">
    <div class="coin-display">ðŸª™ <span id="coin-count-menu">0</span></div>
    <h1>â™” Shakki â™š</h1>
    <div class="menu-buttons">
      <button class="btn-2player" onclick="startGame('2player')">Pelaa kaveria vastaan</button>
      <button class="btn-ai" onclick="showDifficultyMenu()">Pelaa tietokonetta vastaan</button>
    </div>
  </div>

  <div id="difficulty-menu" class="hidden">
    <div class="coin-display">ðŸª™ <span id="coin-count-diff">0</span></div>
    <h2>Valitse vaikeustaso</h2>
    <div class="menu-buttons">
      <button class="btn-easy" onclick="startGame('ai', 'easy')">Helppo</button>
      <button class="btn-medium" onclick="startGame('ai', 'medium')">Keskitaso</button>
      <button class="btn-hard" onclick="startGame('ai', 'hard')">Vaikea</button>
      <button class="btn-expert" onclick="startGame('ai', 'expert')">ErittÃ¤in vaikea</button>
      <button class="btn-back" onclick="backToMenu()">Takaisin</button>
    </div>
  </div>

  <div id="game-container" class="hidden">
    <div class="coin-display">ðŸª™ <span id="coin-count-game">0</span></div>
    <div class="game-header">
      <div class="game-status" id="status">Vuoro: Valkoinen</div>
      <div class="game-buttons">
        <button class="btn-fullscreen" onclick="toggleFullscreen()">KokonÃ¤yttÃ¶</button>
        <button class="btn-undo" id="undo-btn" onclick="undoMove()">Peru</button>
        <button class="btn-reset" onclick="resetGame()">Uusi peli</button>
      </div>
    </div>
    <div id="board"></div>
    <button class="btn-menu" onclick="backToMenu()" style="margin-top: 1rem; width: 100%;">Palaa valikkoon</button>
  </div>

  <a href="../index.html" class="footer-link hidden" id="main-footer-link">Takaisin kotisivulle</a>

  <div id="fullscreen-overlay">
    <button id="fullscreen-close" onclick="toggleFullscreen()">Ã—</button>
    <div id="fullscreen-board"></div>
  </div>

  <script>
    // KIRJAUTUMISEN HALLINTA
    function checkAuth() {
      const isLoggedIn = localStorage.getItem('isLoggedIn');
      if (isLoggedIn === 'true') {
        showMainMenu();
      }
    }

    function showMainMenu() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('menu').classList.remove('hidden');
      document.getElementById('main-footer-link').classList.remove('hidden');
      loadCoins();
    }

    function redirectToLogin() {
      window.location.href = "https://ilari2024.github.io/kirjaudu/";
    }

    function skipLogin() {
      showMainMenu();
    }

    // Suoritetaan tarkistus heti
    checkAuth();

    const pieceSymbols = {
      'k': 'â™š', 'q': 'â™›', 'r': 'â™œ', 'b': 'â™', 'n': 'â™ž', 'p': 'â™Ÿ',
      'K': 'â™š', 'Q': 'â™›', 'R': 'â™œ', 'B': 'â™', 'N': 'â™ž', 'P': 'â™Ÿ'
    };

    let board = [];
    let gameMode = null;
    let difficulty = null;
    let currentPlayer = 'white';
    let selectedSquare = null;
    let legalMoves = [];
    let moveHistory = [];
    let gameOver = false;
    let isFullscreen = false;

    // KOLIKKOSYSTEEMI
    let coins = 5;
    
    function loadCoins() {
      const savedCoins = localStorage.getItem('ilariCoins');
      if (savedCoins !== null) {
        coins = parseInt(savedCoins);
      } else {
        coins = 5;
        saveCoins();
      }
      updateCoinDisplays();
    }

    function saveCoins() {
      localStorage.setItem('ilariCoins', coins.toString());
      updateCoinDisplays();
    }

    function updateCoinDisplays() {
      const menuDisplay = document.getElementById('coin-count-menu');
      const diffDisplay = document.getElementById('coin-count-diff');
      const gameDisplay = document.getElementById('coin-count-game');
      
      if(menuDisplay) menuDisplay.textContent = coins;
      if(diffDisplay) diffDisplay.textContent = coins;
      if(gameDisplay) gameDisplay.textContent = coins;
    }

    function addCoins(amount) {
      coins += amount;
      saveCoins();
    }

    function initializeBoard() {
      const b = Array(8).fill(null).map(() => Array(8).fill(null));
      b[0] = ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'];
      b[1] = Array(8).fill('p');
      b[6] = Array(8).fill('P');
      b[7] = ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R'];
      return b;
    }

    function isWhitePiece(piece) { return piece && piece === piece.toUpperCase(); }

    function showDifficultyMenu() {
      document.getElementById('menu').classList.add('hidden');
      document.getElementById('difficulty-menu').classList.remove('hidden');
    }

    function backToMenu() {
      document.getElementById('menu').classList.remove('hidden');
      document.getElementById('difficulty-menu').classList.add('hidden');
      document.getElementById('game-container').classList.add('hidden');
      resetState();
    }

    function resetState() {
      board = initializeBoard();
      gameMode = null;
      difficulty = null;
      currentPlayer = 'white';
      selectedSquare = null;
      legalMoves = [];
      moveHistory = [];
      gameOver = false;
    }

    function startGame(mode, diff = null) {
      gameMode = mode;
      difficulty = diff;
      resetState();
      document.getElementById('menu').classList.add('hidden');
      document.getElementById('difficulty-menu').classList.add('hidden');
      document.getElementById('game-container').classList.remove('hidden');
      renderBoard();
      updateStatus();
    }

    function renderBoard() {
      const boardEl = isFullscreen ? document.getElementById('fullscreen-board') : document.getElementById('board');
      boardEl.innerHTML = '';
      
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const square = document.createElement('div');
          square.className = (isFullscreen ? 'fullscreen-square ' : 'square ') + ((r + c) % 2 === 0 ? 'light' : 'dark');
          if (selectedSquare && selectedSquare[0] === r && selectedSquare[1] === c) square.classList.add('selected');
          
          const piece = board[r][c];
          if (piece) {
            const el = document.createElement('span');
            el.textContent = pieceSymbols[piece];
            el.className = (isFullscreen ? 'fullscreen-piece ' : '') + (isWhitePiece(piece) ? 'white-piece' : 'black-piece');
            square.appendChild(el);
          }
          
          if (legalMoves.some(m => m[0] === r && m[1] === c)) {
            const dot = document.createElement('div');
            dot.className = 'legal-move';
            square.appendChild(dot);
          }
          
          square.onclick = () => handleSquareClick(r, c);
          boardEl.appendChild(square);
        }
      }
      document.getElementById('undo-btn').disabled = moveHistory.length === 0;
    }

    function toggleFullscreen() {
      isFullscreen = !isFullscreen;
      document.getElementById('fullscreen-overlay').classList.toggle('active', isFullscreen);
      renderBoard();
    }

    function updateStatus() {
      document.getElementById('status').textContent = gameOver ? gameOver : `Vuoro: ${currentPlayer === 'white' ? 'Valkoinen' : 'Musta'}`;
    }

    function getLegalMoves(row, col) {
      const piece = board[row][col];
      if (!piece) return [];
      const isWhite = isWhitePiece(piece);
      if ((isWhite && currentPlayer !== 'white') || (!isWhite && currentPlayer !== 'black')) return [];

      const moves = [];
      const type = piece.toLowerCase();

      const add = (r, c) => {
        if (r < 0 || r > 7 || c < 0 || c > 7) return false;
        const t = board[r][c];
        if (!t) { moves.push([r, c]); return true; }
        if (isWhitePiece(t) !== isWhite) moves.push([r, c]);
        return false;
      };

      if (type === 'p') {
        const d = isWhite ? -1 : 1;
        if (!board[row + d]?.[col]) {
          moves.push([row + d, col]);
          if ((isWhite && row === 6 || !isWhite && row === 1) && !board[row + 2 * d]?.[col]) moves.push([row + 2 * d, col]);
        }
        [-1, 1].forEach(dc => {
          const t = board[row + d]?.[col + dc];
          if (t && isWhitePiece(t) !== isWhite) moves.push([row + d, col + dc]);
        });
      } else if (type === 'n') {
        [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(m => add(row + m[0], col + m[1]));
      } else if (type === 'b') {
        [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d => { for(let i=1; i<8; i++) if(!add(row+d[0]*i, col+d[1]*i) || board[row+d[0]*i][col+d[1]*i]) break; });
      } else if (type === 'r') {
        [[1,0],[-1,0],[0,1],[0,-1]].forEach(d => { for(let i=1; i<8; i++) if(!add(row+d[0]*i, col+d[1]*i) || board[row+d[0]*i][col+d[1]*i]) break; });
      } else if (type === 'q') {
        [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d => { for(let i=1; i<8; i++) if(!add(row+d[0]*i, col+d[1]*i) || board[row+d[0]*i][col+d[1]*i]) break; });
      } else if (type === 'k') {
        [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(m => add(row + m[0], col + m[1]));
      }
      return moves;
    }

    function handleSquareClick(r, c) {
      if (gameOver || (gameMode === 'ai' && currentPlayer === 'black')) return;
      if (selectedSquare && legalMoves.some(m => m[0] === r && m[1] === c)) {
        makeMove(selectedSquare[0], selectedSquare[1], r, c);
      } else {
        const p = board[r][c];
        if (p && ((currentPlayer === 'white' && isWhitePiece(p)) || (currentPlayer === 'black' && !isWhitePiece(p)))) {
          selectedSquare = [r, c];
          legalMoves = getLegalMoves(r, c);
        } else {
          selectedSquare = null;
          legalMoves = [];
        }
      }
      renderBoard();
    }

    function makeMove(fr, fc, tr, tc) {
      moveHistory.push({ fr, fc, tr, tc, p: board[fr][fc], cap: board[tr][tc] });
      board[tr][tc] = board[fr][fc];
      board[fr][fc] = null;
      currentPlayer = currentPlayer === 'white' ? 'black' : 'white';
      selectedSquare = null;
      legalMoves = [];
      checkGameOver();
      renderBoard();
      updateStatus();
      if (!gameOver && gameMode === 'ai' && currentPlayer === 'black') setTimeout(makeAIMove, 500);
    }

    function checkGameOver() {
      let wk = false, bk = false;
      board.flat().forEach(p => { if (p === 'K') wk = true; if (p === 'k') bk = true; });
      
      if (!wk) {
        gameOver = 'Musta voitti!';
        if (gameMode === 'ai') addCoins(-5);
      } else if (!bk) {
        gameOver = 'Valkoinen voitti!';
        if (gameMode === 'ai') addCoins(5);
      }
    }

    function makeAIMove() {
      let moves = [];
      for (let r=0; r<8; r++) {
        for (let c=0; c<8; c++) {
          if (board[r][c] && !isWhitePiece(board[r][c])) {
            getLegalMoves(r, c).forEach(m => moves.push({ f: [r, c], t: m }));
          }
        }
      }
      if (moves.length === 0) return;
      let move;
      if (difficulty === 'easy') move = moves[Math.floor(Math.random() * moves.length)];
      else {
        moves.forEach(m => { m.s = (board[m.t[0]][m.t[1]] ? 10 : 0) + Math.random(); });
        moves.sort((a, b) => b.s - a.s);
        move = moves[0];
      }
      makeMove(move.f[0], move.f[1], move.t[0], move.t[1]);
    }

    function undoMove() {
      if (moveHistory.length === 0) return;
      const l = moveHistory.pop();
      board[l.fr][l.fc] = l.p;
      board[l.tr][l.tc] = l.cap;
      currentPlayer = currentPlayer === 'white' ? 'black' : 'white';
      selectedSquare = null;
      legalMoves = [];
      gameOver = false;
      renderBoard();
      updateStatus();
    }

    function resetGame() { startGame(gameMode, difficulty); }

    board = initializeBoard();
  </script>
</body>
</html>
